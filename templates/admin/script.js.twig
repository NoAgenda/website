window.addEventListener('load', () => {
  document.querySelectorAll('[data-feedback]').forEach(feedbackElement => {
    const expandButton = feedbackElement.querySelector('[data-feedback-expand]');
    const expandButtonIcon = feedbackElement.querySelector('[data-feedback-expand] span');
    const playButton = feedbackElement.querySelector('[data-feedback-play]');
    const details = feedbackElement.querySelector('[data-feedback-details]');
    const player = feedbackElement.querySelector('audio');

    player.addEventListener('loadedmetadata', () => {
      player.currentTime = player.dataset.startsAt;
    });

    let isExpanded = false;
    const expand = () => {
      isExpanded = true;

      expandButtonIcon.classList.remove('fa-chevron-down');
      expandButtonIcon.classList.add('fa-chevron-up');
      details.classList.remove('d-none');

      if (!player.readyState) {
        player.load();
      }
    };
    const collapse = () => {
      isExpanded = false;

      expandButtonIcon.classList.remove('fa-chevron-up');
      expandButtonIcon.classList.add('fa-chevron-down');
      details.classList.add('d-none');

      player.pause();
    };

    expandButton.addEventListener('click', () => {
      if (isExpanded) {
        collapse();
      } else {
        expand();
      }
    });

    playButton.addEventListener('click', () => {
      if (!isExpanded) {
        expand();
      }

      player.play().then(() => {
        player.currentTime = player.dataset.startsAt;
      });
    })
  });
});
