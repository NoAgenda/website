{% extends 'layout.html.twig' %}

{% import _self as macro %}

{% macro play_button(size, class) %}
<na-audio-play class="{{ class }}" data-target="episodePlayer">
  <div class="cursor-pointer" role="button" aria-hidden="false" aria-label="Play" data-play-button>
    <span class="fal fa-{{ size }}x fa-fw fa-play" aria-hidden="true"></span>
  </div>
  <div class="cursor-pointer d-none" role="button" aria-hidden="true" aria-label="Pause" data-pause-button>
    <span class="fal fa-{{ size }}x fa-fw fa-pause" aria-hidden="true"></span>
  </div>
</na-audio-play>
{% endmacro %}

{% macro seek_button(direction, seconds, class, button_class) %}
{% set icon = direction == 'forward' ? 'fa-redo-alt' : 'fa-undo-alt' %}
{% set label = direction == 'forward' ? "Skip #{seconds} seconds" : "Go back #{seconds} seconds" %}

<na-audio-seek
  class="{{ class }}"
  data-target="episodePlayer"
  data-direction="{{ direction }}"
  data-seconds="{{ seconds}}"
>
  <div class="btn cursor-pointer {{ button_class }}" role="button" aria-label="{{ label }}">
    <span class="fal {{ icon }} mr-1" aria-hidden="true"></span> {{ seconds }}s
  </div>
</na-audio-seek>
{% endmacro %}

{% macro progress_bar(big) %}
{% set class = big ? 'd-none d-lg-block py-3' : 'flex-grow-1' %}
{% set bar_height = big ? '30' : '5' %}
{% set duration_color = big ? 'bg-white' : 'bg-dark' %}
{% set progress_color = big ? 'bg-primary' : 'bg-highlight' %}
{% set pointer_color = big ? 'bg-highlight' : 'bg-white' %}

<na-audio-progress
  class="{{ class }}"
  data-target="episodePlayer"
>
  {% if big %}
  <div class="position-relative d-flex justify-content-between">
    <span aria-label="Current timestamp" data-progress>0:00</span>
    <span aria-hidden="true">&nbsp;</span>
    <span aria-label="End timestamp" data-duration>0:00</span>
    <span class="position-absolute d-none" aria-hidden="true" data-seek>0:00</span>
  </div>
  <div class="position-relative {{ duration_color }} cursor-pointer mt-2" aria-hidden="true" style="height: 30px;" data-duration-bar>
    <div class="position-absolute {{ progress_color }} h-100" style="width: 0;" data-progress-bar></div>
    <div class="position-absolute {{ pointer_color }} h-100 d-none" style="width: 3px; z-index: 2;" data-pointer></div>
  </div>
  {% else %}
  <div>
    <div class="d-inline-block" style="min-width: 120px;">
      <span aria-label="Current timestamp" data-progress>0:00</span>
      <span aria-hidden="true" data-pointer-hide>/</span>
      <span aria-label="End timestamp" data-duration>0:00</span>
      <span class="d-none" aria-hidden="true" data-seek data-still>0:00</span>
    </div>
    <div class="d-none d-md-inline ml-4" data-chapter-name></div>
  </div>
  <div class="cursor-pointer" aria-hidden="true" data-duration-bar>
    <div class="py-2">
      <div class="position-relative {{ duration_color }}" style="height: 5px;">
        <div class="position-absolute {{ progress_color }} h-100" style="width: 0;" data-progress-bar></div>
        <div class="position-absolute {{ pointer_color }} h-100 d-none" style="width: 3px; z-index: 2;" data-pointer></div>
      </div>
    </div>
  </div>
  {% endif %}
</na-audio-progress>
{% endmacro %}

{% set title = episode.code ~ ': ' ~ episode.name %}

{% block title %}{{ title|raw }}{% endblock %}

{% set tabs = [
  {
    key: 'info',
    icon: '<span class="fal fa-fw fa-info" aria-hidden="true"></span> <span class="d-md-none">' ~ episode.code ~ '</span>',
    name: title,
    contents: 'player/blocks/information.html.twig',
    enabled: true,
  },
  {
    key: 'transcript',
    icon: '<span class="fal fa-fw fa-list-ol" aria-hidden="true"></span>',
    name: 'Transcript <span class="badge badge-secondary text-uppercase">Beta</span>',
    contents: 'player/blocks/transcript.html.twig',
    enabled: episode.transcript,
  },
  {
    key: 'chat',
    icon: '<span class="fal fa-fw fa-smile" aria-hidden="true"></span>',
    name: 'Troll room',
    contents: 'player/blocks/chat.html.twig',
    enabled: episode.chatMessages,
  },
] %}

{% block body %}
{{ parent() }}

{% include 'player/blocks/correction_modal.html.twig' %}
{% include 'player/blocks/suggestion_modal.html.twig' %}
{% include 'player/blocks/success_modal.html.twig' %}

<na-audio
  id="episodePlayer"
  data-src="{{ episode.recordingUri }}"
  data-timestamp="{{ timestamp }}"
></na-audio>
{% endblock %}

{% block body_attributes %}
{% apply spaceless %}
  {% if transcriptTimestamp != 0 %}
    data-transcript-timestamp="{{ transcriptTimestamp }}"
  {% endif %}
{% endapply %}
{% endblock %}

{% block content %}
<div class="site-masthead-player">
  <div class="container">
    <div class="d-sm-flex">
      <img class="masthead-cover img-fluid" src="{{ asset(episode.code ~ '.png')|imagine_filter('cover_large') }}" alt="Art for episode {{ episode.code }}">
      <div class="flex-grow-1 pb-3 pb-sm-0 pt-2 pt-sm-0 m-sm-3 m-md-4 m-lg-5">
        <h1>{{ title }}</h1>
        <h4>{{ episode.author }}</h4>
        <div class="btn-toolbar">
          {% if episode.duration %}
          <div class="btn btn-sm btn-outline-light disabled mt-2 mr-2" aria-label="Duration">
            <span class="fas fa-clock mr-1" aria-hidden="true"></span>
            {{ episode.duration|visualTimestamp }}
          </div>
          {% endif %}
          <div class="btn btn-sm btn-outline-light disabled mt-2" aria-label="Publish date">
            <span class="fas fa-calendar mr-1" aria-hidden="true"></span>
            {{ episode.publishedAt|date('F jS, Y') }}
          </div>
        </div>
        <div class="btn-toolbar d-none d-lg-flex align-items-center justify-content-center pt-5" role="toolbar" aria-label="Player controls">
          {{ macro.seek_button('backward', 60, 'mx-2', 'btn-sm btn-light') }}
          {{ macro.seek_button('backward', 15, 'mx-2', 'btn-sm btn-light') }}
          {{ macro.play_button(3, 'mx-4') }}
          {{ macro.seek_button('forward', 15, 'mx-2', 'btn-sm btn-light') }}
          {{ macro.seek_button('forward', 60, 'mx-2', 'btn-sm btn-light') }}
        </div>
      </div>
    </div>
    <div>
      {{ macro.progress_bar(true) }}
    </div>
  </div>
</div>

<div class="container mt-3">
  <na-audio-history data-target="episodePlayer"></na-audio-history>
</div>

<div class="site-interactive-player container min-vh-100">
  <div class="row">
    <div class="player-main-col col-12">
      <div class="d-flex flex-column min-vh-100">
        <div class="flex-grow-0 bg-white position-sticky top-0 pt-3" role="navigation" style="z-index: 1000;">
          <ul class="player-tabs nav nav-tabs">
            {% for tab in tabs if tab.enabled %}
            <li class="nav-item">
              <a
                {% set classes = ['nav-link cursor-pointer'] %}
                {% if loop.first %}{% set classes = classes|merge(['active']) %}{% endif %}
                {% if tab.key == 'chat' %}{% set classes = classes|merge(['d-xl-none']) %}{% endif %}
                id="{{ tab.key }}-tab"
                class="{{ classes|join(' ') }}"
                href="#{{ tab.key }}"
                role="tab"
                data-toggle="tab"
                aria-controls="{{ tab.key }}"
                aria-selected="{{ loop.first ? 'true' : 'false' }}"
                {% if tab.key == 'chat' %}data-chat-activator{% endif %}
              >
                {{ tab.icon|raw }}
                <span class="d-none d-md-inline ml-1">{{ tab.name|raw }}</span>
              </a>
            </li>
            {% endfor %}

            {% if episode.chatMessages %}
            <li class="player-chat-activator nav-item ml-auto d-none d-xl-block">
              <div class="nav-link cursor-pointer" data-chat-activator>
                <span class="fal fa-fw fa-smile" aria-hidden="true"></span> Troll room
              </div>
            </li>
            {% endif %}
          </ul>
        </div>
        <div class="flex-grow-1 tab-content pt-4">
          {% for tab in tabs if tab.enabled %}
          <div class="tab-pane fade {{ loop.first ? 'active show' : '' }}" id="{{ tab.key }}" role="tabpanel" aria-labelledby="{{ tab.key }}-tab">
            {% include tab.contents %}
          </div>
          {% endfor %}
        </div>
        <div class="bottom-holder flex-grow-0 position-sticky p-2" style="bottom: 0; z-index: 1000;">
          <div class="d-sm-flex">
            <div class="btn-toolbar d-flex align-items-center justify-content-center mb-2 mb-md-0">
              {{ macro.seek_button('backward', 15, 'ml-3 mr-2', 'btn-sm btn-outline-dark') }}
              {{ macro.play_button(2, 'mx-2') }}
              {{ macro.seek_button('forward', 15, 'ml-2 mr-3', 'btn-sm btn-outline-dark') }}
            </div>
            {{ macro.progress_bar(false) }}
          </div>
        </div>
      </div>
    </div>
    <div class="player-aside-col col-xl-4 d-none">
      <div class="d-flex flex-column min-vh-100 max-vh-100 position-sticky top-0 pt-3">
        <div class="flex-shrink-0">
          <ul class="nav nav-tabs">
            <li class="nav-item">
              <div class="nav-link disabled">
                <span class="fal fa-fw fa-smile" aria-hidden="true"></span> Troll room
              </div>
            </li>
          </ul>
        </div>

        {% if episode.chatNotice %}
        <div class="alert alert-warning alert-dismissible fade show m-0" role="alert">
          {{ episode.chatNotice }}
          <button type="button" class="close" data-dismiss="alert" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        {% endif %}
        <div class="chat-loader text-center my-4">
          <span class="fas fa-spinner fa-spin" aria-hidden="true"></span> Loading troll messages...
        </div>
        <div class="chat-container flex-grow-1 oy-scroll my-4">
          {% include 'player/blocks/chat_container.html.twig' %}
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
